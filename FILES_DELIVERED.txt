# OpenShift 4.16 AWS Installation - Files Delivered

This document lists all files in the OpenShift_4.16 delivery package and their purpose.

================================================================================
ROOT DIRECTORY
================================================================================

README.md
    Main documentation file covering:
    - Complete OpenShift 4.16 installation procedure on AWS
    - Red Hat official prerequisites and documentation references
    - IAM policies, network, and firewall requirements
    - Custom installer modifications and build process
    - Terraform automation setup and deployment
    - Custom AMI creation with KMS encryption
    - Step-by-step installation guide with troubleshooting
    - Cluster cleanup and destruction procedures

FILES_DELIVERED.txt
    This file - complete inventory of all delivered files and their purposes

.gitattributes
    Git configuration for line ending handling:
    - Forces Unix (LF) line endings for .sh, .tf, .yaml, .md files
    - Prevents Windows CRLF issues in Linux environments
    - Ensures scripts execute correctly on RHEL bastion hosts

.vscode/
    ├── settings.json
        VS Code/Cursor editor configuration:
        - Enforces LF line endings for this project
        - Ensures consistent file formatting across team

================================================================================
custom-ami-build/
================================================================================
Directory containing scripts and documentation for creating custom RHCOS AMIs
with AWS KMS encryption.

custom-ami-build/README.md
    Complete guide for building custom RHCOS AMIs:
    - Prerequisites for AMI creation
    - AWS permissions and IAM role requirements (vmimport)
    - KMS key creation and configuration
    - Step-by-step AMI build process
    - Troubleshooting import issues

custom-ami-build/create-custom-ami.sh
    Main automation script for AMI creation:
    - Downloads official RHCOS VMDK from Red Hat mirror
    - Decompresses VMDK file
    - Uploads to S3 bucket
    - Imports snapshot with KMS encryption
    - Creates encrypted AMI with IMDSv2 support
    - Cleans up temporary resources

custom-ami-build/example-usage.sh
    Example script showing how to use create-custom-ami.sh:
    - Sample environment variable configuration
    - Proper command syntax
    - Expected output examples

custom-ami-build/.gitignore
    Prevents committing sensitive or temporary files:
    - Downloaded VMDK files
    - AWS credentials
    - Temporary S3 upload artifacts

================================================================================
openshift-installer-modifications.4.16/
================================================================================
Directory containing modified OpenShift installer source code files for
custom behavior required for shared VPC/subnet deployments.

openshift-installer-modifications.4.16/README.md
    Detailed explanation of installer modifications:
    - Why modifications are needed (shared VPC/subnets)
    - List of all modified files and changes
    - Environment variables for controlling installer behavior
    - Build instructions for custom installer
    - How to apply modifications to upstream source

openshift-installer-modifications.4.16/pkg/asset/cluster/aws/aws.go
    Modified AWS cluster creation logic:
    - Adds IgnoreErrorsOnSharedTags environment variable check
    - Allows installer to proceed when tagging shared VPC resources fails
    - Required when VPC/subnets are managed outside OpenShift

openshift-installer-modifications.4.16/pkg/asset/installconfig/clusterid.go
    Modified cluster ID (InfraID) generation:
    - Adds ForceOpenshiftInfraIDRandomPart environment variable
    - Allows controlling the random suffix of InfraID
    - Enables predictable cluster naming for automation

openshift-installer-modifications.4.16/pkg/asset/releaseimage/default.go
    Default release image configuration:
    - Sets default OpenShift release image
    - Function for retrieving release image URL
    - Used when release_image not specified

openshift-installer-modifications.4.16/pkg/destroy/aws/shared.go
    Modified cluster destroy logic for shared resources:
    - Adds SkipDestroyingSharedTags environment variable check
    - Skips removal of tags from shared VPC/subnet resources
    - Adds IgnoreErrorsOnSharedTags for graceful failure handling
    - Prevents destroy failures when resources are shared

================================================================================
terraform-openshift-v18/
================================================================================
Terraform automation for OpenShift 4.16 installation on AWS with custom
installer integration, IAM role creation via ccoctl, and cluster lifecycle
management.

--------------------------------------------------------------------------------
DOCUMENTATION
--------------------------------------------------------------------------------

terraform-openshift-v18/README.md
    Comprehensive Terraform module documentation:
    - Prerequisites and required tools (ccoctl installation)
    - Red Hat documentation references
    - Module overview and architecture
    - Quick start guide
    - Configuration file explanations
    - Deployment and destruction procedures
    - Troubleshooting common issues
    - Version history and support information

terraform-openshift-v18/README
    Version notes and internal change log:
    - Differences between v17 and v16
    - Internal development notes
    - Technical implementation details
    - Kept for historical reference

terraform-openshift-v18/env/VARIABLES-EXPLAINED.md
    Comprehensive variable documentation:
    - Detailed explanation of every Terraform variable
    - How to find/configure each value
    - AWS account ID, region, availability zones
    - Network configuration (VPC, subnets, CIDR ranges)
    - IAM policies and permission boundaries
    - KMS key configuration
    - DNS and Route53 hosted zones
    - Release images for disconnected environments
    - SSH keys and authentication

--------------------------------------------------------------------------------
CONFIGURATION FILES
--------------------------------------------------------------------------------

terraform-openshift-v18/env/demo.tfvars
    Main Terraform variable definitions file:
    - AWS account and region configuration
    - Cluster name and InfraID
    - Network settings (VPC, subnets, CIDR blocks)
    - IAM role names and policies
    - KMS encryption aliases
    - DNS domain and hosted zone
    - OpenShift version and release image
    - SSH public key for cluster access
    - Template for customer-specific deployments

terraform-openshift-v18/variables.tf
    Terraform variable declarations:
    - Defines all input variables with types
    - Default values where applicable
    - Variable descriptions
    - Used by Terraform to validate tfvars input

terraform-openshift-v18/providers.tf
    Terraform provider configuration:
    - AWS provider setup with region from variables
    - Provider version constraints
    - Authentication configuration

terraform-openshift-v18/backend.tf.disabled
    S3 backend configuration (disabled by default):
    - Template for remote state storage in S3
    - DynamoDB table for state locking
    - Can be enabled by removing .disabled extension
    - Local state used by default for simplicity

--------------------------------------------------------------------------------
TERRAFORM RESOURCE DEFINITIONS
--------------------------------------------------------------------------------

terraform-openshift-v18/main.tf
    Core Terraform resources:
    - SSH key pair generation and upload
    - Local file outputs for keys
    - Resource dependencies and ordering

terraform-openshift-v18/main.openshift.tf
    OpenShift-specific provisioning:
    - ccoctl key pair creation (serviceaccount-signer keys)
    - OIDC provider configuration (dry-run generation)
    - S3 OIDC bucket creation and file upload
    - IAM OIDC identity provider creation
    - IAM roles creation via ccoctl (control plane, workers)
    - Handles permissions boundaries conditionally

terraform-openshift-v18/iam.tf
    IAM resources for OpenShift:
    - Control plane IAM role and policy
    - Worker node IAM role and policy
    - EC2 instance profiles
    - Permissions for AWS integrations (ELB, EBS, etc.)

terraform-openshift-v18/s3.tf
    S3 bucket for OIDC provider:
    - Creates bucket for OIDC discovery documents
    - Public read access for OIDC federation
    - Bucket policy for OpenID Connect

terraform-openshift-v18/s3.dynamo.tf
    (Optional) Remote state backend resources:
    - S3 bucket for Terraform state storage
    - DynamoDB table for state locking
    - Versioning and encryption configuration
    - Can be disabled if using local state

terraform-openshift-v18/ssh_key.tf
    SSH key management:
    - Generates RSA key pair if not exists
    - Stores private key locally
    - Uploads public key to AWS

terraform-openshift-v18/templates.tf
    Template generation for OpenShift configs:
    - install-config.yaml template (cluster configuration)
    - cluster_ingress manifest template
    - infra machinesets template
    - KMS alias and subnet data sources
    - Network type set to OVNKubernetes (4.16 requirement)

terraform-openshift-v18/openshift.prepare.tf
    OpenShift manifest preparation:
    - Extracts CredentialsRequest manifests from release image
    - Runs openshift-install create manifests
    - Applies custom ingress configuration
    - Creates infra machinesets
    - Prepares cluster for installation

terraform-openshift-v18/openshift.install.tf
    OpenShift cluster installation execution:
    - Runs openshift-install create cluster
    - Sets environment variables for custom installer behavior
    - Monitors installation progress
    - Saves cluster state and credentials
    - Runs backup script to S3

terraform-openshift-v18/openshift.day2.tf
    Day 2 operations (post-installation):
    - Updates ingress controller DNS records
    - Retrieves ingress load balancer
    - Creates Route53 records for *.apps domain

terraform-openshift-v18/output.tf
    Terraform outputs:
    - Cluster information (API URL, console URL)
    - Credentials location
    - OIDC provider ARN
    - IAM role ARNs
    - Displayed after successful deployment

--------------------------------------------------------------------------------
SHELL SCRIPTS - CLUSTER LIFECYCLE
--------------------------------------------------------------------------------

terraform-openshift-v18/create-cluster.sh
    Wrapper script for cluster creation:
    - Sets environment variables for custom installer
    - Calls openshift-install create cluster
    - Used by openshift.install.tf

terraform-openshift-v18/clean-cluster.sh
    Cluster cleanup orchestration:
    - Called by terraform destroy
    - Fetches installer-files from S3 if missing locally
    - Gracefully handles S3 bucket absence
    - Runs delete-cluster.sh with timeout
    - Deletes DNS records (api, api-int)
    - Calls delete-roles.sh to remove IAM roles

terraform-openshift-v18/delete-cluster.sh
    OpenShift cluster destruction:
    - Sets environment variables (SkipDestroyingSharedTags, etc.)
    - Runs openshift-install destroy cluster
    - Checks for metadata.json existence
    - Returns proper exit codes for error handling
    - Warns if resources may remain

terraform-openshift-v18/save-cluster-states.sh
    Backup cluster state to S3:
    - Creates tar archive of installer-files directory
    - Uploads to S3 bucket (if exists)
    - Ensures local backup even if S3 upload fails
    - Preserves metadata.json, kubeconfig, credentials

--------------------------------------------------------------------------------
SHELL SCRIPTS - IAM AND DNS MANAGEMENT
--------------------------------------------------------------------------------

terraform-openshift-v18/delete-roles.sh
    IAM role cleanup:
    - Deletes all IAM roles created by ccoctl
    - Handles role naming patterns for cluster
    - Detaches managed policies before deletion
    - Removes inline policies
    - Used during cluster destroy

terraform-openshift-v18/manual-cleanup.sh
    Comprehensive manual cleanup script for stuck resources:
    - Cleans up IAM roles and policies that already exist
    - Empties and deletes S3 buckets (OIDC and state)
    - Removes OIDC identity providers
    - Handles EntityAlreadyExists errors
    - Use when terraform destroy fails
    - Configured for eu-west-3 region

terraform-openshift-v18/force-delete-iam.sh
    Force delete IAM resources causing EntityAlreadyExists errors:
    - Detaches all managed policies from roles
    - Deletes all inline policies from roles
    - Removes roles from instance profiles
    - Deletes policies after detaching from all entities
    - Handles all edge cases (users, groups, versions)
    - Deletes OIDC S3 bucket
    - Safe to run multiple times (checks existence first)

terraform-openshift-v18/delete-role.sh
    Single IAM role deletion:
    - Deletes one specific IAM role by name
    - Detaches all attached policies
    - Removes inline policies
    - Helper script for manual cleanup

terraform-openshift-v18/delete-record.sh
    Route53 DNS record deletion:
    - Removes A records from hosted zone
    - Used for api and api-int subdomains
    - Handles record set deletion safely

terraform-openshift-v18/test-roles.sh
    IAM role validation:
    - Tests if required IAM roles exist
    - Verifies role permissions
    - Checks policy attachments
    - Troubleshooting helper

--------------------------------------------------------------------------------
SHELL SCRIPTS - UTILITIES
--------------------------------------------------------------------------------

terraform-openshift-v18/get-ingress-lb.sh
    Retrieves ingress load balancer information:
    - Queries OpenShift for ingress controller
    - Extracts load balancer DNS name
    - Used for DNS record creation
    - Called during Day 2 operations

terraform-openshift-v18/wait.sh
    Polling utility for Terraform:
    - Waits for a command to succeed
    - Retries with configurable intervals
    - Exits after max retries or success
    - Generic helper for resource readiness checks

terraform-openshift-v18/env.sh
    Environment setup script:
    - Sets AWS credentials
    - Exports environment variables
    - Source before running Terraform commands
    - Template for customer environment

--------------------------------------------------------------------------------
OPENSHIFT CONFIGURATION TEMPLATES
--------------------------------------------------------------------------------

terraform-openshift-v18/openshift/openshift_pull_secret.json
    Red Hat pull secret template:
    - Required for downloading OpenShift images
    - Obtain from console.redhat.com
    - Must be customized before deployment
    - Contains authentication for quay.io and registries

================================================================================
FILE COUNT SUMMARY
================================================================================

Documentation:              6 files
Configuration:              5 files
Terraform Resources:       11 files
Shell Scripts:             15 files
Source Code (Go):           4 files
Git/Editor Config:          3 files
                          ---
TOTAL:                     44 files

================================================================================
MODIFICATION TRACKING
================================================================================

Last Updated: 2026-01-23
Version: 4.16 (Custom Installer Build)
Compatibility: OpenShift 4.16.x, Terraform 1.5+, AWS Provider 5.0+

================================================================================
NOTES
================================================================================

1. All shell scripts use Unix (LF) line endings enforced by .gitattributes
2. Terraform files use local state by default (backend.tf.disabled)
3. Custom installer must be built before running Terraform
4. ccoctl tool is required and must be installed separately
5. AWS credentials must be configured before deployment

================================================================================
